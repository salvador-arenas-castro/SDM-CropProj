
# SDM-CropProj - Model assisted framework to forecast the environmental suitability and production of crops

<img src="https://upload.wikimedia.org/wikipedia/commons/8/84/Olivesfromjordan.jpg" 
alt="Olive tree in Jordan" style="width: 180px;"/>

This repository contains code and data for running the Arenas-Castro & Gonçalves (2020) 
framework for forecasting olive crop environmental suitability as well as total annual 
production by region. 

Despite this framework has been implemented and tested with several olive crop varieties 
in Andalusia (Spain), it is expected to be applicable to other crop species or varieties 
and other agroecosystems worldwide.


# 1. Folder structure

- __DATA__: test data for running the package
- __OUTPUTS__: outputs generated by the modelling framework
- __RCODE__: scripts used to implement the workflow

![warning-icon](https://img.icons8.com/emoji/48/000000/warning-emoji.png)
__WARNING__: do not change the name of these folders as this will be prevent the 
analysis from running properly.


# 2. DATA folder structure and test data

The DATA folder subdivides into the following sub-folders:

- __PredictorVariables__: contains predictor variables used to explain the environmental 
suitability and distribution of the response variable (i.e. presence/absence of target 
crop(s), more specifically olive varieties)

   - _Current_: spatial data in raster format (filetype: ESRI ASCII) for current conditions. 
   Test data Coordinate Reference System is WGS 1894 Geographic. All data layers contain the same 
   number of columns and rows as well as equal spatial extent as to allow their overlap. 
   Climatic variables (see list below: 1,2,5,6,8) represent average values for the interval 1961-2000. 
   The following variables are included:

   |File name           |Description                           |
   |--------------------|--------------------------------------|
   |1. _et_ref.asc_     |Evapotranspiration (EVTP; mm/year)    |
   |2. _ic.asc_         |Continentality index (IDCT; °C)       |
   |3. _orient.asc_     |Solar orientation (SLOR; degrees)     |
   |4. _ph.asc_         |Soil pH (SLPH)                        |
   |5. _prec_oto.asc_   |Autumn precipitation (PRAU; mm)       |
   |6. _prec_ver.asc_   |Summer precipitation (PRSM; mm)       |
   |7. _pte_pct.asc_    |Slope (SLPC; %)                       |
   |8. _tmed_inv.asc_   |Average winter temperature (TPWT; °C) |

   - _Future_: This directory contains a set of sub-folders one for each required projection 
   scenario/date. For testing purposes, the example data includes the Local Scenarios of Climate 
   Change of Andalusia (ELCCA) (URL: http://www.juntadeandalucia.es/medioambiente/site/rediam). 
   These regional climate change scenarios were specifically developed for the Andalusia region 
   to represent the changes expected in the climate in the coming decades, according to studies 
   carried out on a planetary scale. More specifically, the following projection dates are 
   included (*): 
      - 2040
      - 2070
      - 2100

![info-icon](https://img.icons8.com/flat_round/48/000000/info.png)
__NOTE__: only climatic variables (1,2,5,6,8) are changed in relation to current conditions. 
The remaining variables (3,4,7) are copies since these are considered temporally "static". 
For simplicity sake, it is better to copy static variables for each projection folder.

![warning-icon](https://img.icons8.com/emoji/48/000000/warning-emoji.png)
__WARNING__: File names of predictor variables inside the current and future folders must be exactly the same 
since these will be used as names for the predictor variables in biomod2 modelling routines. 
Modifying file names or having differences between them will cause the projection step to fail!!


- __ProductivityData__: multi-year (2010-2014) olive crop production data (in tons) 
and cultivated surface area for Andalusia (filename: _Olive_ProductionSurface_Andalusia_2010_2014.csv_).

- __Regions__: a raster dataset containing administrative regions

- __ResponseVariable__: Presence records for each target crop(s), in this case olive varieties for the 
spanish Andalusia region. Table _OLIVE_VARIETIES_DATA_all.csv_ contains presence-only data for eight 
varieties in total:

   |Target                | Code | Main features                                      | Area (km^2^) |
   |----------------------|------|----------------------------------------------------|--------------|
   |Acebuche              | Oe   | Wild species of reference                          | 2161         |
   |Hojiblanca            | Hj   | Very frequent olive-tree variety in plant nursery  | 7868         |
   |Lechín de Sevilla     | Lch  | Frequent olive-tree variety in plant nursery       | 3221         |
   |Manzanilla de Sevilla | Mnz  | Frequent table olive-tree variety in plant nursery | 2654         |
   |Nevadillo negro       | Nvd  | Traditional olive-tree variety                     | 1114         |
   |Picudo                | Pcd  | Traditional olive-tree variety                     | 2459         |
   |Picual                | Pcl  | Very frequent olive-tree variety in plant nursery  | 18677        |
   |Verdial de Huévar     | Vrd  | Traditional olive-tree variety                     | 865          |

   - The table has four columns:
      - ID: observation identifier	
      - X: longitude (in decimal degrees)
      - Y: latitude (in decimal degrees)
      - NAME: name of the crop species or variety (i.e. olive variety code - see table above)


![warning-icon](https://img.icons8.com/emoji/48/000000/warning-emoji.png)
__WARNING__: do not change the names of the fields/columns in the input table 
containing species records! These are fixed or "hard-coded" and will make the analysis fail 
if modified. If you have a previous table with input x,y records do not forget to adjust the 
header according to these names.


![warning-icon](https://img.icons8.com/emoji/48/000000/warning-emoji.png)
__WARNING__: do not change the name of these sub-folders as this will be prevent the 
analysis from working properly. Exception of course for subfolder(s) name(s) inside 
_PredictorVariables/Future_.


# 3. Workflow

- Clone the repo to a target local folder using: 
`git clone https://github.com/salvador-arenas-castro/SDM-CropProj.git`;

- If you wish to use your own data start by cleaning each one of the _DATA_ subfolders: 
_PredictorVariables/Current_, _PredictorVariables/Future_, _ProductivityData_, _Regions_, 
and, _ResponseVariable_. This way the analysis routines will use your own data and not get 
it mixed with the example data. Replace by your own data formated as the example data and 
following the instructions above;

- The main workflow is composed by two scripts that need to be run in sequence:

   1) __SDMcalibrationForecasting-v1.R__ - this will generate the predicitve distribution/suitability 
   models for all target species/varieties considering current conditions and make spatial projections 
   for all dates/scenarios (both for current and future conditions);
   
   2) __FitRegression_SuitableArea_vs_Productivity-v1.R__ - this script will gather model projections 
   from biomod2 (from step 1), calculate the total area suitable for all species/varities and related 
   that with annual production data through a log-log model as in Arenas-Castro et al (2020).


## 3.1. SDM calibration, evaluation and ensemble projections


### 3.1.1. Inputs

Three main inputs are required to run the __SDMcalibrationForecasting-v1.R__ script:

(i) A set of modeling outputs placed in the OUTPUTS/MODS folder and  generated
By the SDMcalibrationForecasting-v1.R script.

(ii) Total Annual productivity data (either single or multi-year) by region of interest
formatted as a csv table placed in the DATA/productivityData folder. This table should
contain the following fields/columns:
    (a) region names
    (b) region unique ID codes (in integer values)
    (c) year
    (d) annual production

(iii) A GeoTIFF Raster file with region data. Each region is identified by an
integer value, the same used as the unique ID in the Total Annual productivity
table. This is necessary to enable joining the data across these sources. To
enable area calculations this should be in a projected coordinate system or  (check
below PROJ_RASTER_DATA and PROJ_COORD_SYSTEM parameter).


### 3.1.2. Parameters for running

_PRODUCTIVITY_TABLE_NAME_
Annual productivity table as a CSV file

_RESP_VAR_FIELD_NAME_
Name of the field/column with annual/multi-annual productivity data. 
This column should be inside the table located in the DATA/ProductivityData folder

_REGION_ID_FIELD_NAME_
Name of the field that contains the region unique identifier code 
(an ineteger values). This code must be the same used in the region raster 
file inside the DATA/Regions folder.

_REGION_NAME_FIELD_NAME_
Field/column name containing the region names

_IS_MULTI_YEAR_
Is productivity data multi-annual? If TRUE the annual data will be firstly 
aggregated using the average and then used as input for regression with SDM 
suitable area as predictor

_YEAR_FIELD_NAME_
Name of the field/column with the reference year. 

_SDM_RST_BAND_INDEX_
Raster band index to use from each species binary SDM. This represents
which combination of ensemble measure / threshold metric is used to construct
the species/variey raster stack. The file has a total of 9 bands which represent the
two-factor combination of: (1) average ensemble, (2) median ensemble, and (3)
the weighted average ensemble vs. (A) TSS threshold, (B) ROC threshold and, (C)
Kappa threshold. The 9 bands are in the following order: 1A, 1B, 1C, 2A, 2B, 2C,
3A, 3B, 3C.

_COORD_SYSTEM_
Coordinate system of the data (must be the same for species records and
predictor variables in raster format). The projection name is a PROJ4-like string.
The default is set to WGS 1984 geographic coordinate system
Set as NULL if not needed or if data already has a defined coordinate system.

_PROJ_RASTER_DATA_
Set this to  TRUE if the raster data needs to be re-projected to a different
coordinate reference system as to allow area calculations. This may be required if
the original data is in a geographic coordinate system.
Set to FALSE if data does not require a re-projection to a projected system.

_PROJ_COORD_SYSTEM_
A CRS PROJ4 string that will be used to re-project the raster input data.

_RST_SPATIAL_RES_
Spatial resolution (pixel size) to attribute to the re-projected raster 
(usually in meters)

_VERBOSE_
Print progress messages? If TRUE messages and progress bars will be displayed.


### 3.1.3. Outputs 

Outputs from biomod2 will be placed onto _OUTPUTS/MODS_. Inside this, one directory for 
each modelled species/variety will appear. Inside each species folder, projection results 
will appear in directories labelled with a _proj__ prefix where spatial results can be cheched 
more easily in any GIS software (or R) using results in the _GeoTIFF_ subfolder. 

Each calibrated model object are located in the _models_ subfolder. Do not change nor delete this 
folder as this will make recovering or reusing modelling objects impossible.

Model evaluation scores are displayed in csv files with the suffixes:

-  _evalDF_KAPPA.csv_: Kappa scores for partial models
-  _evalDF_TSS.csv_: TSS scores for partial models
-  _evalDF_ROC.csv_: ROC scores for partial models
- _EnsMod_evalDF_AllMetrics.csv_: final scores for the ensemble model containing 
TSS, ROC and Kappa metrics as well as the threshold applied to "binarize" models, 
along with sensitivity and specificity values.

Variable importance score are displayed in a csv folder with suffix _varImportance.csv_


## 3.2. Fitting the log-log productivity model

### 3.2.1. Inputs

Three main inputs are required to run this script:

(i) A set of modeling outputs placed in the OUTPUTS/MODS folder and  generated
By the SDMcalibrationForecasting-v1.R script.

(ii) Total Annual productivity data (either single or multi-year) by region of interest
formatted as a csv table placed in the DATA/productivityData folder. This table should
contain the following fields/columns:
    (a) region names
    (b) region unique ID codes (in integer values)
    (c) year
    (d) annual production

(iii) A GeoTIFF Raster file with region data. Each region is identified by an
integer value, the same used as the unique ID in the Total Annual productivity
table. This is necessary to enable joining the data across these sources. To
enable area calculations this should be in a projected coordinate system or  (check
below PROJ_RASTER_DATA and PROJ_COORD_SYSTEM parameter).


### 3.2.2. Parameters for running

_PRODUCTIVITY_TABLE_NAME_
Annual productivity table as a CSV file

_RESP_VAR_FIELD_NAME_
Name of the field/column with annual/multi-annual productivity data.
This column should be inside the table located in the DATA/ProductivityData folder

_REGION_ID_FIELD_NAME_
Name of the field that contains the region unique identifier code
(an ineteger values). This code must be the same used in the region raster
file inside the DATA/Regions folder.

_REGION_NAME_FIELD_NAME_
Field/column name containing the region names

_IS_MULTI_YEAR_
Is productivity data multi-annual? If TRUE the annual data will be firstly
aggregated using the average and then used as input for regression with SDM
suitable area as predictor

_YEAR_FIELD_NAME_
Name of the field/column with the reference year.

_SDM_RST_BAND_INDEX_
Raster band index to use from each species binary SDM. This represents
which combination of ensemble measure / threshold metric is used to construct
the species/variey raster stack. The file has a total of 9 bands which represent the
two-factor combination of: (1) average ensemble, (2) median ensemble, and (3)
the weighted average ensemble vs. (A) TSS threshold, (B) ROC threshold and, (C)
Kappa threshold. The 9 bands are in the following order: 1A, 1B, 1C, 2A, 2B, 2C,
3A, 3B, 3C.

_COORD_SYSTEM_
Coordinate system of the data (must be the same for species records and
predictor variables in raster format). The projection name is a PROJ4-like string.
The default is set to WGS 1984 geographic coordinate system
Set as NULL if not needed or if data already has a defined coordinate system.

_PROJ_RASTER_DATA_
Set this to  TRUE if the raster data needs to be re-projected to a different
coordinate reference system as to allow area calculations. This may be required if
the original data is in a geographic coordinate system.
Set to FALSE if data does not require a re-projection to a projected system.

_PROJ_COORD_SYSTEM_
A CRS PROJ4 string that will be used to re-project the raster input data.

_RST_SPATIAL_RES_
Spatial resolution (pixel size) to attribute to the re-projected raster
(usually in meters)

_VERBOSE_
Print progress messages? If TRUE messages and progress bars will be displayed.


### 3.2.3 Outputs

Model outputs will be placed the _OUTPUTS/PROD_MODS_ directory. 

A multiband raster with all species binary projections (0/1, unsuitable/suitable) 
in files with suffix _SpBinEnvSuit.tif_ and its total overlap in _AllSpBinEnvSuit.tif_.

Also includes model summaries and diagnostics for the log-log annual production model 
by region.


# 4. Contacts

If you need assistance using these analysis scripts or to adjust them to your specific aims, 
do contact us at:

_Salvador Arenas-Castro_: salvadorarenascastro [at] cibio.up.pt

_João F Gonçalves_: joao.goncalves [at] cibio.up.pt
